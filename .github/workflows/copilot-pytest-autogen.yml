name: Copilot-Pytest-AutoGen

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-test-gen:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PYTHONPATH: .

    steps:
      # üß± 1Ô∏è‚É£ Checkout full repository history (for diff comparison)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}

      # üóÇÔ∏è 2Ô∏è‚É£ Ensure folder structure exists
      - name: Ensure folder structure
        run: |
          mkdir -p src tests .github/scripts
          echo "üìÇ Directory structure ready"

    # ü§ñ 3Ô∏è‚É£ Install GitHub CLI and Copilot CLI
      - name: Install GitHub CLI and Copilot CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq npm
          echo "üß© Installing GitHub Copilot CLI via npm..."

          # Install the modern Copilot CLI (2025 version)
          npm install -g @githubnext/github-copilot-cli

          # Verify CLI installed successfully
          echo "‚úÖ Verifying Copilot CLI installation..."
          if ! command -v github-copilot-cli &> /dev/null; then
            echo "‚ùå Copilot CLI not found in PATH!"; exit 1;
          fi

          github-copilot-cli --help | head -20 || true
          echo "‚úÖ Copilot CLI installation complete"

    

    #   # ü§ñ 3Ô∏è‚É£ Install GitHub CLI + Copilot CLI
    #   - name: Install GitHub Copilot CLI
    #     run: |
    #         sudo apt-get update -y
    #         sudo apt-get install -y npm jq
    #         echo "üß© Installing GitHub Copilot CLI via npm..."
    #         npm install -g @githubnext/github-copilot-cli
    #         echo "‚úÖ Copilot CLI installed successfully"
    #         github-copilot-cli --help || echo "‚öôÔ∏è Copilot CLI ready"

      # üêç 4Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # üì¶ 5Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov coverage

      # üß† 6Ô∏è‚É£ Verify generator script
      - name: Verify generator script
        run: |
          if [ ! -f ".github/scripts/copilot_test_gen.py" ]; then
            echo "‚ùå Missing .github/scripts/copilot_test_gen.py. Please commit it before running this workflow."
            exit 1
          fi
          echo "‚úÖ Generator script found in repo."

      # ‚ö° 7Ô∏è‚É£ Run Copilot Test Generator (generate ‚Üí validate ‚Üí commit)
      - name: Run Copilot Test Generator
        run: |
          echo "üöÄ Starting Copilot Test Generator..."
          python .github/scripts/copilot_test_gen.py
          echo "üìä Running pytest with coverage..."
          pytest -q --disable-warnings --maxfail=1 \
            --cov=src --cov-report=term --cov-report=xml \
            | tee pytest_output.log

      # üßæ 8Ô∏è‚É£ Post PR Comment Summary (with test counts + coverage)
      - name: Post Copilot Test Summary on PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(jq -r .pull_request.number < "$GITHUB_EVENT_PATH")
          STATUS="${{ job.status }}"
          echo "üîç Collecting pytest results..."

          TESTS_PASSED=0
          TESTS_FAILED=0
          PLACEHOLDER_COUNT=0
          COVERAGE="N/A"

          if [ -f pytest_output.log ]; then
            TESTS_PASSED=$(grep -Eo "[0-9]+ passed" pytest_output.log | awk '{print $1}' | tail -n1 || echo 0)
            TESTS_FAILED=$(grep -Eo "[0-9]+ failed" pytest_output.log | awk '{print $1}' | tail -n1 || echo 0)
            COVERAGE_LINE=$(grep -E "TOTAL\s+[0-9]+\s+[0-9]+\s+[0-9]+\s+[0-9]+%" pytest_output.log | tail -n1)
            if [ -n "$COVERAGE_LINE" ]; then
              COVERAGE=$(echo "$COVERAGE_LINE" | grep -Eo "[0-9]+%$" | tr -d '%')
            fi
          fi

          PLACEHOLDER_COUNT=$(grep -R "test_placeholder" tests/ 2>/dev/null | wc -l || echo 0)

          if [ "$STATUS" = "success" ] && [ "$TESTS_FAILED" -eq 0 ]; then
            if [ "$PLACEHOLDER_COUNT" -gt 0 ]; then
              RESULT="‚ö†Ô∏è $TESTS_PASSED passed, 0 failed ($PLACEHOLDER_COUNT placeholder)."
            else
              RESULT="‚úÖ $TESTS_PASSED passed, 0 failed."
            fi
          elif [ "$TESTS_FAILED" -gt 0 ]; then
            RESULT="‚ùå $TESTS_FAILED failed, $TESTS_PASSED passed."
          else
            RESULT="‚ùå Copilot test generation or pytest validation failed."
          fi

          if [ "$COVERAGE" != "N/A" ]; then
            RESULT="$RESULT Coverage: ${COVERAGE}%."
          fi

          BODY="ü§ñ **Copilot Test Automation Summary**  
          ‚Ä¢ Status: **$STATUS**  
          ‚Ä¢ Result: $RESULT  
          _Check workflow logs for details._"

          echo "üßæ Posting comment to PR #$PR_NUMBER ..."
          gh pr comment "$PR_NUMBER" --body "$BODY"
