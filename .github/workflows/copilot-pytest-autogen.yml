name: Copilot-Pytest-AutoGen

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-test-gen:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PYTHONPATH: .

    steps:
      # ğŸ§± 1ï¸âƒ£ Checkout full repository history (so git diff works)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      # ğŸ—‚ï¸ 2ï¸âƒ£ Ensure directory structure exists
      - name: Ensure folder structure
        run: |
          mkdir -p src tests .github/scripts
          echo "ğŸ“‚ Directory structure ready"

      # ğŸ¤– 3ï¸âƒ£ Install GitHub CLI and Copilot extension
      - name: Install GitHub CLI and Copilot
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          gh extension install github/gh-copilot
          echo "âœ… Copilot CLI installed successfully."
          gh --version
          echo "ğŸ”‘ Authenticating Copilot CLI..."
          gh auth status || gh auth login --with-token <<< "${GITHUB_TOKEN}"
          echo "ğŸ” Copilot CLI authenticated."

      # ğŸ 4ï¸âƒ£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ğŸ“¦ 5ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov

      # ğŸ§  6ï¸âƒ£ Verify generator script exists in repo
      - name: Verify generator script
        run: |
          if [ ! -f ".github/scripts/copilot_test_gen.py" ]; then
            echo "âŒ Missing .github/scripts/copilot_test_gen.py. Please commit it before running this workflow."
            exit 1
          fi
          echo "âœ… Generator script found in repo."

      # âš¡ 7ï¸âƒ£ Run Copilot-based test generation
      - name: Run Copilot Test Generator
        run: |
          echo "ğŸš€ Starting Copilot Test Generator..."
          python .github/scripts/copilot_test_gen.py

      # ğŸ§¾ 8ï¸âƒ£ (Optional) Post result summary comment on PR
      # Uncomment below if you want Copilot test summary posted to PR
      #
      # - name: Post PR Comment Summary
      #   if: always()
      #   run: |
      #     PR_NUMBER=$(jq -r .pull_request.number < "$GITHUB_EVENT_PATH")
      #     STATUS="${{ job.status }}"
      #     BODY="ğŸ¤– **Copilot Test Generation Result:** $STATUS\nCheck workflow logs for details."
      #     gh pr comment "$PR_NUMBER" --body "$BODY"
